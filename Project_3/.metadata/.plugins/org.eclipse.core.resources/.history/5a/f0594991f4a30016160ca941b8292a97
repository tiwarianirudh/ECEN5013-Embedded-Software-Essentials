/*
 * messageint.c
 *
 *  Created on: Nov 4, 2016
 *      Author: Mukund Madhusudan Atre
 */
#include "MKL25Z4.h"
#include <stdint.h>
#include "rxtestled.h"
#include "messageint.h"
#include "uart.h"

uint8_t *intptr;
inptr = (uint8_t*) calloc(4,sizeof(uint8_t));


void message_in()
{
uint8_t i,c = 0;

while(i<4)
{
	c = UART0->D;
	*(inptr+i) = c;
    i++;
}
pkt->command = *(inptr);
pkt->length = *(inptr+1);
pkt->data = *(inptr+2);
pkt->checksum = *(inptr+3);
}

void cmd_action()
{
  if (pkt->command == LED_COLOR)
  {
    if (pkt->data[0] == RED_LED )
    {
      LED_set('R');
    }
    else if (pkt->data[0] == GREEN_LED)
    {
      LED_set('G');
    }
    else if (pkt->data[0] == BLUE_LED)
    {
      LED_set('B');
    }

  }

  else if (pkt->command == LED_BRIGHT)
  {
	LED_set('R');
    if (pkt->data[0] == LOW)
    {
      TPM2_BASE_PTR->CONTROLS[0].CnV = 150;
      TPM2_BASE_PTR->CONTROLS[1].CnV = 0;
      TPM0_BASE_PTR->CONTROLS[1].CnV = 0;
    }
    else if (pkt->data[0] == MEDIUM)
    {
      TPM2_BASE_PTR->CONTROLS[0].CnV = 600;
      TPM2_BASE_PTR->CONTROLS[1].CnV = 0;
      TPM0_BASE_PTR->CONTROLS[1].CnV = 0;

    }
    else if (pkt->data[0] == HIGH)
    {
      TPM2_BASE_PTR->CONTROLS[0].CnV = 900;
      TPM2_BASE_PTR->CONTROLS[1].CnV = 0;
      TPM0_BASE_PTR->CONTROLS[1].CnV = 0;

    }
    else
    {
      send_string("Invalid data");
    }

  }

  else
  {
    send_string("Invalid command");
  }
}
